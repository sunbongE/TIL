# 1:N관계

**User(1) : Comment(N)** 

- user은 **0개 이상**의 comment을 가질 수 있다.

---

## Comment FK

comment가 외래키로 user의 pk을 저장해서 참조할 수 있는 관계로 만든다.

```python
#article/models.py

class Comment(models.Model):
    content = models.CharField(max_length=80)
    article = models.ForeignKey(
        Article,
        on_delete = models.CASCADE
    )
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
```

![image-20221019164305187](1%EB%8C%80N%EA%B4%80%EA%B3%84.assets/image-20221019164305187-16661653875741.png)

---

## Create

인증된 회원의 댓글 작성 구현, 작성 전 로그인을 먼저 진행한 상태



### CommentForm

```python
class CommentForm(forms.ModelForm):

    class Meta:
        model = Comment
        fields = ["content",]
# fields = '__all__' 으로 할 경우 user 까지 선택할 수 있는 이상한 화면이 되기 때문에 필드는 직접 
#선택해야한다.
```

이 상태로 댓글을 작성하면 추가했던 user 값을 받아올 수 없기 때문에 에러가 나옴

그러면 아래와 같이 `comment.user = request.user `을 추가한다.



```python
#views.py

def comment_create(request,pk)  :
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm(request.POST)
    if comment_form.is_valid():
        comment=comment_form.save(commit=False)
        comment.article = article
        comment.user = request.user
        comment.save()
    return redirect('articles:detail', article.pk)
```

---

## Read

```python
{% for comment in comments %}
    {% if request.user == comment.user %}
    <a href="{% url 'articles:comment_delete' article.pk comment.pk %}" class='btn btn-danger float-end'>삭제</a>
    {% endif %}
      <div class=''>
        <p > {{comment.user}}님 </p> # 작성자 
        <p>{{ comment.content }}</p> # 댓글
      </div>
      <hr>
      <br>

      {%empty%}
      <p>댓글이 없어요 ㅠ_ㅠ</p>
    {% endfor %}
```

---

## Delete

사용자가 다른 사용자의 댓글을 지우는 것을 막아야하고

그 기능은 템플릿과 뷰에서 각각 처리해줘야 한다.

템플릿만 처리하면 url타고 들어갈 수 있기 때문

```python
#views.py
def comment_delete(request,pk,comment_pk):
    comment = Comment.objects.get(pk = comment_pk)
    if request.user == comment.user: # 요청한 사용자와 댓글의 사용자가 같다면
        comment.delete()
    return redirect('articles:detail',pk)
```

```python
 #detail.html
    {% if request.user == comment.user %}
    <a href="{% url 'articles:comment_delete' article.pk comment.pk %}" class='btn btn-danger float-end'>삭제</a>
    {% endif %}
```

