# 댓글 비동기 구현

> 아직은 저도 공부하는 단계라서 이 방법이 완벽한 것이 아니다.  
>
> 완벽하기 위해서는 더 깔끔한 코드와 views.py에서 for문을 통한 실시간 댓글 처리가 필요하다

1. 뷰에서 JsonResponse으로 data를 넘겨준다.

2. 댓글이 나오는 페이지에서 axios으로 넘겨준다.

**JS 벡틱 부분은 따로 아래에서 언급**



```python
# views.py
def comment_create(request, review_pk):
    review = get_object_or_404(Review, pk=review_pk)
    result = request.POST['parent']

    if request.method == "POST":                        # POST요청이고
        if request.user.is_authenticated:               # 로그인된 상태면
                # 댓글일 때
            comment_form = CommentForm(request.POST)    # POST으로 요청온 정보를 받아서
            if comment_form.is_valid():                 # 유효성 검사하고
                comment = comment_form.save(commit=False) # 저장 멈춰
                # 외래키 입력
                comment.review = review 
                comment.user = request.user
                # 저장
                comment.save()
                
                data = {                   # js에서 response data으로 사용할 값을 넘겨준다.
                    "review_pk": review_pk,
                    "comment_pk": comment.pk,
                    "content": comment.content,
                    "userName": comment.user.username,
                    "comment_image" : comment.user.profile_image.url
                }
                return JsonResponse(data)
        else:
            return HttpResponse(status=403)
    else:
        return redirect("accounts:login")
    
    
    

@login_required
def comment_delete(request, product_pk, review_pk, comment_pk):
    comment = get_object_or_404(Comment, pk=comment_pk)
    if request.user == comment.user:
        if request.method == "POST":
            comment.delete()

    data = {}
    return JsonResponse(data)

```



![comment](%EB%8C%93%EA%B8%80_%EB%B9%84%EB%8F%99%EA%B8%B0%EA%B5%AC%ED%98%84.assets/comment.gif)



댓글이 작성되면 댓글들을 담고있는 틀안에 넣는 것이 중요한데 댓글을 담고있는 div에 id값을 줘야한다.

![image-20221126180714005](%EB%8C%93%EA%B8%80_%EB%B9%84%EB%8F%99%EA%B8%B0%EA%B5%AC%ED%98%84.assets/image-20221126180714005.png)

이 부분이 댓글을 담고있는 div이고 여기에 id 입력

![image-20221126180632977](%EB%8C%93%EA%B8%80_%EB%B9%84%EB%8F%99%EA%B8%B0%EA%B5%AC%ED%98%84.assets/image-20221126180632977.png)

그리고 댓글들에 **id = "com{{comment.pk}}"** 이렇게 해서 각 댓글에 **고유한 id**를 줘야 나중에 삭제가 가능하다.

댓글의 class는 전부 같은 것으로 만들었는데 그 이유는 천천히 살펴보자



이런식으로 큰 div(댓글을 담는 div)를 지정했다면 js에서 비동기 처리에 필요한 요청을 보내야한다.

코드가 길다 천천히 보자

```javascript
const product_pk = document.querySelector('#product_pk').dataset.infoId

    const commentForm = document.querySelector('#comment-form') // html에서 댓글생성 요청하는 폼의 아이디
    //console.log(commentForm)
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value // post요청에 필요한 토큰을 알려주는거 필수임

      commentForm.addEventListener('submit', function (event) { //폼에서 제출버튼을 누르면
        event.preventDefault(); // 이거는 눌렀을때 뷰로 가는 것을 막는것 왜냐면 안막이면 창이 새로고침되는 현상이있음 동기 요청을 보내버렸다는것
        axios({
          method: 'POST', 															// 메소드 정하는거
          url: `/reviews/${event.target.dataset.detailId}/review_detail/comments/`, // 요청할 url입력하면됨
          headers: { 																// 헤더에는 토큰을 담아서 넘겨야한다.
            'X-CSRFToken': csrftoken
          },
          data: new FormData(commentForm)											//방금 작성한 댓글을 담고있는 거라고 생각하면된다.
        }) // 이렇게 요청을 받아서 성공적으로 받으면 then으로 아니면 catch으로가는데 지금은 then만 사용했다.
          .then(response => {
            
            //console.log(response.data.review_pk)

              const comments = document.querySelector('#comments') // html에서 아까의 큰div를 변수에 담은거
              //아래 코드는 큰div 안에 가장 아래줄에 벡틱에 있는 내용을 붙이겠는다는 내용이다.
              comments.insertAdjacentHTML('beforeend', `
              <div class="container" id="com${response.data.comment_pk}">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <div class="d-flex align-items-center">
                    {% if '${response.data.comment_image}' %}
                    <img src="${response.data.comment_image}" alt="{{ review.user.profile_image }}" width="33px" height="33px" style="border-radius: 50%;">
                    {% else %}
                    <lord-icon src="https://cdn.lordicon.com/bhfjfgqz.json" trigger="hover" style="width:33px; height:33px; border-radius: 50%;"></lord-icon>
                    {% endif %}
                    <span class="text-muted ms-2 font-space">${response.data.userName}</span>
                  </div>
                  <a class="mb-0 mx-3 text-truncate font-space text-decoration-none text-black" data-bs-toggle="modal" data-bs-target="#commentDetailModal${response.data.comment_pk}">${response.data.content}</a>
                  <div class="modal fade shadow-lg" id="commentDetailModal${response.data.comment_pk}" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered rounded-0">
                      <div class="modal-content p-3 rounded-0">
                        <div class="text-end">
                          <button type="button" class="btn-close" style="width: 5px; height:5px;" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-start">
                          <pre class="mb-0 font-space" id="modalLabel" style="font-size: 16px;">${response.data.content}</pre>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class='comments_set'>
                    <form data-product-id='${product_pk}' data-review-id='${response.data.review_pk}' data-comment-id='${response.data.comment_pk}' action="http://127.0.0.1:8000/reviews/${product_pk}/${response.data.review_pk}/review_detail/comments/${response.data.comment_pk}/comment_delete/" method="POST">
                      {% csrf_token %}
                      <input class="btn btn-outline-dark rounded-0" type="submit" value="삭제">
                    </form>
                  </div>
                </div>
                <div class='d-flex align-items-center'>
                  <hr class="border border-dark border-1 opacity-50 d-block me-2" width="25px;">
                  <a href="" class='text-decoration-none text-dark recomBox'><span data-box-id=${response.data.comment_pk} class='text-muted'>답글 보기</span></a>
                </div>
                <hr>
                <br>
              </div>`);

//이 부분은 비동기로 생성된 댓글은 이벤트가 없기때문에 이벤트를 주는 과정이다.
            result = document.querySelector(`#com${response.data.comment_pk}`) // 아까 설정한 고유한 댓글아이디로 댓글을 선택함
            //console.log(result)
            result.addEventListener('submit', event => {  // 제출이 되었을 때 즉 삭제 버튼을 눌렀을 때 반응하는 것이다.
              event.preventDefault()
              //console.log(event.target.dataset)
              const product_pk = event.target.dataset.productId // 삭제요청을 비동기로 보내기위해 url에 들어갈 변수들을 받아온거
              const review_pk = event.target.dataset.reviewId
              const comment_pk = event.target.dataset.commentId
              
//여기서  event.target.dataset 이란 어디서 올까? 바로 html form에서 data-review-id={{review.pk}} 이런식으로 들어가있던 것을 여기에서 사용하려고한것이었다.                
                
                
              axios({ // 삭제요청
                method: 'post',
                url: `/reviews/${product_pk}/${review_pk}/review_detail/comments/${comment_pk}/comment_delete/`,
                headers: {
                  'X-CSRFToken': csrftoken
                }
              })
                .then(response => { // respones.data를 받으면
                  const deldiv = document.getElementById(`com${comment_pk}`) // 삭제할 댓글의 아이디선택하여
                  //console.log(deldiv)
                  deldiv.remove(); //삭제
                })

            })
            commentForm.reset() //이부분은 댓글 폼에 작성하고 만들어지면 폼에 남아있는 내용이 다시 비워지는 것을 의미한다.
          })
          .catch(error => {
            console.log(error.response)
            if (error.response.status === 403) {
              alert("로그인을 먼저 해주세요!")
              window.location.href = '{% url "accounts:login" %}';
            }
          })
      })
```



### html form부분

```html
 <form id='parentform' data-product-id='{{ product.pk }}' data-review-id='{{ review.pk }}' data-comment-id='{{ comment.pk }}' action="{% url 'reviews:comment_delete' product.pk review.pk comment.pk %}" method="POST">
                          {% csrf_token %}
                          <input class="btn btn-outline-dark rounded-0" type="submit" value="삭제">
                        </form>
```

아까 언급했듯  `data-product-id='{{ product.pk }}'` 이런 것들은 event.target.dataset에 포함되어 JS에서 사용 가능하다.



## 벡틱부분

위에 있던 벡틱에 들어있는 엄청나게 긴 코드는 html이고 이것은 바로

![image-20221126183308345](%EB%8C%93%EA%B8%80_%EB%B9%84%EB%8F%99%EA%B8%B0%EA%B5%AC%ED%98%84.assets/image-20221126183308345.png)



하나의 댓글이다.

![image-20221126183332299](%EB%8C%93%EA%B8%80_%EB%B9%84%EB%8F%99%EA%B8%B0%EA%B5%AC%ED%98%84.assets/image-20221126183332299.png)

더 자세한 내용은 insertAdjacentHTML() 구글링해보면 알기 쉽게 나옴 

무튼 위에 있는 html코드를 그대로 **복붙** 한 것이고 if문 같은 분기 처리가 있는 부분 또한 사용 가능 하지만 만약 변수로 response으로 받은 데이터가 아닌 다른 데이터를 사용한다면 제한된다.

 form에서 아래와 같은 부분은 url을 직접 적었는데 이렇게 하지 않으면 에러가 나서 별수 없었다.

```javascript
action="http://127.0.0.1:8000/reviews/${product_pk}/${response.data.review_pk}/review_detail/comments/${response.data.comment_pk}/comment_delete/"

//${product_pk} 이부분은 무엇인가 또 궁금할 수 있는데 코드를 보면 알 수 있지만 설명을 하자면
const product_pk = event.target.dataset.productId 
```



## 삭제 비동기 요청

이 부분이 먼저 만들어져 있어야 위에서 비동기로 생성된 댓글의 삭제를 할 수 있다. 

```javascript
//삭제 js
    const commentDel = document.querySelectorAll('.comments_set')
    commentDel.forEach(form => {
      form.addEventListener('submit', event => {
        event.preventDefault()
        //console.log(event.target.dataset)
        const product_pk = event.target.dataset.productId
        const review_pk = event.target.dataset.reviewId
        const comment_pk = event.target.dataset.commentId
        axios({
          method: 'post',
          url: `/reviews/${product_pk}/${review_pk}/review_detail/comments/${comment_pk}/comment_delete/`,
          headers: {
            'X-CSRFToken': csrftoken
          }
        })
          .then(response => {
            const deldiv = document.getElementById(`com${comment_pk}`)
            //console.log(deldiv)
            
            deldiv.remove();

          })
          .catch(error => {
            //console.log(deldiv)
          })
      })
    })
```

