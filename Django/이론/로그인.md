# 로그인에 대한 이해

내가 누구인지 알고 있어야 함!

## HTTP

- 비 연결 지향 (connectionless)

  - 서버는 요청에 대한 응답을 보낸 후 연결을 끊음

    

- 무상태 (stateless)

  - 연결을 끊는 순간 클라와 서버 간의 통신이 끝나며 상태 정보가 유지되지 않음
  - 클라와 서버가 주고받는 메시지들은 서로 완전히 독립적



## 로그인 유지

서버와 클라이언트 간 지속적인 상태 유지를 위해 "쿠키와 세션" 이 존재



### 쿠키

서버가 사용자의 웹 브라우저에 전송하는 작은 데이터 조각

사용자가 웹 사이트를 방문할 경우 해당 웹사이트의 서버를 통해 사용자의 컴퓨터에 설치되는 작은 기록 정보 파일

쿠키는 서로 다른 요청이 동일한 브라우저로부터 발생한 것인지 판단할 때 주로 사용됨 

예시) 쿠팡 장바구니에 담아둔 상품 정보가 유지되는 것



쿠키 사용 목적

- 세션 관리(sesstion management)
  - 로그인, 아이디 자동완성, 공지 하루 안 보기, 팝업 체크, 장바구니 등의 정보 관리
- 개인화 (Personalization)
  - 사용자 선호, 테마 등의 설정
- 트래킹 (Tracking)
  - 사용자 행동을 기록 및 분석

쿠키의 수명

- Session cookie
  - 현재 세션이 종료되면 삭제됨
  - 브라우저 종료와 함께 세션이 삭제됨
- Persistent cookies
  - Expires 속성에 지정된 날짜 혹은 Max-Age 속성에 지정된 기간이 지나면 삭제됨



### 세션

사이트와 특정 브라우저 사이의 상태를 유지 시키는 것 

클라가 서버에 접속하면 서버가 특정 session id을 발급하고, 클라는 session id를 쿠키에 저장

- 클라가 다시 동일한 서버에 접속하면 요청과 함께 쿠키를 서버에 전달
- 쿠키는 요청마다 서버에 함께 전송되므로 서버에서 session id을 확인해 알 맞는 로직을 처리

session id는 세션을 구별하기 위해 필요하며, 쿠키에는 session id만 저장



## Login

login(request, user, backend=None)

인증된 사용자를 로그인

​	유저의 ID를 세션에 저장하여 제션을 기록

HttpRequest 객체와 User 객체가 필요

 유저 정보는 반드시 인증된 유저 정보여야함

- authenticate()함수를 활용한 인증
- AuthenticationForm을 활용한 is_valid()

AuthenticationForm

- 로그인을 위한 built-in-form
  - 로그인 하고자 하는 가용자 정보를 입력 받음(username, password)
  - ModelForm이 아닌 일반 Form을 상속 받고 있으며, request를 첫번째 인자로 취함

```python
from django.contrib.auth.forms import AuthenticationForm
```



### 로그인 로직 작성

ModelForm기반의 Create 로직과 동일 하지만 

ModelForm이 아닌 Form으로 필수 인자 구성이 다름

DB에 저장하는 것 대신 세션에 유저를 기록하는 함수 호출함

- View함수와 이름이 동일하여 변경하여 호출
- 로그인 URL이 /accounts/login/에서 변경되는 경우 settings.py LOGIN_URL을 변경해야 함

```python
#로그인 구현
from django.contrib.auth import login as auth_login

def login(request):
    if request.method == 'POST':
        form = AuthenticationForm(request, form.get_user())
        #AuthenticationForm는 ModelForm이 아님
        return redirect('app_name:index')
    else:
        form = AuthenticationForm()
     context={
         'form' = form
     }
    return render(request, '경로/login.html', context)
```

**get_user()**

- AuthenticationForm의 인스턴스 매서드
- 유효성 검사를 통과하면 로그인한 사용자 객체를 반환



### 세션 확인

- 로그인 후 개발자 도구와 DB에서 django으로부터 발급 받은 세션 확인(로그인한 관리자 계정을 만든 후 진행)
- django_session 테이블에서 확인

브라우저에서 확인

- 개발자 도구 - Application - Cookies



## context processors

- 템플릭이 렌더링 될 때 호출 가능한 컨텍스트 데이터 목록
- 작성된 컨텍스트 데이터는 기본적으로 템플릿에서 사용 가능한 변수로 포함됨
- 즉,  django에서 자주 사용하는 데이터 목록을 미리 템플릿에 로드 해 둔 것



## django.contrib.auth.context_processor.auth

템플릿 변수 {{ user }}

- 클라가 호그인한 경우 User 클래스의 인스턴스
- 클라가 로그인하지 않는 경우 AnonymousUser 클래스의 인스턴스